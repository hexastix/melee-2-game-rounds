<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>2-game rounds for Melee</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    >
  </head>
  <body>
    <nav class="navbar sticky-top bg-body-secondary">
      <div class="container">
        <span class="navbar-brand">2-game rounds for Melee</span>
      </div>
    </nav>
    <div class="container my-4">
      <div class="row d-flex align-items-end">
        <div class="col">
          <label for="players-file-input" class="form-label">Player data (JSON file)</label>
          <input type="file" accept="application/json" id="players-file-input" class="form-control" />
        </div>
        <div class="col">
          <label for="matches-file-input" class="form-label">Tournament matches (JSON file)</label>
          <input type="file" accept="application/json" id="matches-file-input" class="form-control" />
        </div>
        <div class="col">
          <button type="button" id="submit-button" class="form-control">Submit</button>
        </div>
      </div>
    </div>
    <div class="container my-4">
      <h2>Matches</h2>
      <div class="bg-body-secondary">
        <div id="matches-tabs" class="nav nav-pills justify-content-center">
        </div>
      </div>
      <div id="matches-panes" class="tab-content">
        <p>No matches</p>
      </div>
    </div>
    <div class="container my-4">
      <h2>Standings</h2>
      <div class="bg-body-secondary">
        <div id="standings-tabs" class="nav nav-pills justify-content-center">
        </div>
      </div>
      <div id="standings-panes" class="overflow-x-auto tab-content">
        <p>No standings</p>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
      crossorigin="anonymous"
    ></script>
    <script>
      function handleFile(fileInput, validateItems, assignItems) {
        fileInput.parentNode.classList.remove("was-validated");

        const files = fileInput.files;
        switch (files.length) {
          case 0:
            return;
          case 1: {
            const promise = new Promise((resolve, reject) => {
              const file = fileInput.files[0];
              if (file.type === "application/json") {
                const reader = new FileReader();
                reader.onload = (event) => {
                  let items = [];
                  try {
                    items = JSON.parse(event.target.result);
                  } catch {
                    reject("Invalid JSON");
                    return;
                  }

                  const validity = validateItems(items);
                  if (validity === "") {
                    resolve(items);
                  } else {
                    reject(validity);
                  }
                };
                reader.onerror = (event) => {
                  reject("Failed to read the file");
                };
                reader.readAsText(file);
              } else {
                reject("Incorrect file type");
              }
            });
            promise.then((items) => {
              assignItems(items);
              fileInput.setCustomValidity("");
              fileInput.parentNode.classList.add("was-validated");
            }).catch((validity) => {
              fileInput.setCustomValidity(validity);
              fileInput.parentNode.classList.add("was-validated");
            });
            break;
          }
          default:
            fileInput.setCustomValidity("Too many files");
            fileInput.parentNode.classList.add("was-validated");
        }
      }

      function validatePlayers(players) {
        if (!Array.isArray(players)) {
          return "Invalid JSON contents (expected array of players)";
        }
        for (property of ["Username", "PlayerNameLastFirst", "TeamId", "Status"]) {
          if (!players.every((player) => Object.hasOwn(player, property))) {
            return `Invalid JSON contents (missing "${property}" property)`;
          }
        }
        return "";
      }

      var allPlayers = [];
      const assignAllPlayers = (items) => { allPlayers = items; };

      const playersFileInput = document.getElementById("players-file-input");
      playersFileInput.addEventListener(
        "change",
        (event) => { handleFile(playersFileInput, validatePlayers, assignAllPlayers) },
      );

      function validateMatches(matches) {
        if (!Array.isArray(matches)) {
          return "Invalid JSON contents (expected array of matches)";
        }
        for (property of [
          "RoundNumber",
          "Player1Username",
          "Player2Username",
          "Player1GameAndByeWins",
          "Player2GameAndByeWins",
          "HasResults",
          "GameDraws",
        ]) {
          if (!matches.every((match) => Object.hasOwn(match, property))) {
            return `Invalid JSON contents (missing "${property}" property)`;
          }
        }
        const invalidMatches = matches.filter(
          (match) => match.Player1GameAndByeWins + match.Player2GameAndByeWins > 2
        ).length;
        if (invalidMatches !== 0) {
          return (
            `${invalidMatches} match${invalidMatches === 1 ? "" : "es" } with invalid`
            + " result"
          );
        }
        return "";
      }

      var allMatches = [];
      const assignAllMatches = (items) => { allMatches = items; }

      const matchesFileInput = document.getElementById("matches-file-input");
      matchesFileInput.addEventListener(
        "change",
        (event) => { handleFile(matchesFileInput, validateMatches, assignAllMatches) },
      );

      handleFile(playersFileInput, validatePlayers, assignAllPlayers);
      handleFile(matchesFileInput, validateMatches, assignAllMatches);

      const submitButton = document.getElementById("submit-button");
      submitButton.onclick = (event) => {
        playersFileInput.required = true;
        playersFileInput.parentNode.classList.add("was-validated");
        matchesFileInput.required = true;
        matchesFileInput.parentNode.classList.add("was-validated");

        const matchesTabs = document.getElementById("matches-tabs");
        matchesTabs.replaceChildren();

        const matchesPanes = document.getElementById("matches-panes");
        matchesPanes.replaceChildren();

        const standingsTabs = document.getElementById("standings-tabs")
        standingsTabs.replaceChildren();

        const standingsPanes = document.getElementById("standings-panes");
        standingsPanes.replaceChildren();

        if (allMatches.length === 0) {
          const matchesText = document.createElement("p");
          matchesText.appendChild(document.createTextNode("No matches"));
          matchesPanes.replaceChildren(matchesText);

          const standingsText = document.createElement("p");
          standingsText.appendChild(document.createTextNode("No standings"));
          standingsPanes.replaceChildren(standingsText);

          submitButton.blur();
          return;
        }

        const roundNumbers = [
          ... new Set(allMatches.map((match) => match.RoundNumber))
        ].sort();
        const completedRoundNumbers = roundNumbers.filter(
          (number) =>
            Array(number)
              .fill(1)
              .map((x, y) => x + y)
              .filter(value => roundNumbers.includes(value))
              .length === number
            && allMatches
              .filter((match) => match.RoundNumber === number)
              .every((match) => match.HasResults)
        );

        roundNumbers.forEach((number) => {
          const active = number === roundNumbers[roundNumbers.length - 1];

          const roundTab = document.createElement("button");
          roundTab.setAttribute("type", "button");
          roundTab.setAttribute("class", `nav-link my-3 ${active ? "active" : ""}`);
          roundTab.setAttribute("data-bs-toggle", "pill");
          roundTab.setAttribute("data-bs-target", `#matches-round-${number}-pane`);
          roundTab.appendChild(document.createTextNode(`Round ${number}`));
          matchesTabs.appendChild(roundTab);

          const roundPane = document.createElement("div");
          roundPane.setAttribute("class", `tab-pane ${active ? "active" : ""}`);
          roundPane.setAttribute("id", `matches-round-${number}-pane`);

          const matchesTable = document.createElement("table");
          matchesTable.setAttribute("class", "table table-striped table-hover");

          const matchesTableHeader = document.createElement("thead");
          const matchesTableHeaderRow = matchesTableHeader.insertRow();
          [["Player 1", 40], ["Result", 20], ["Player 2", 40]].forEach((elem) => {
            const [text, width] = elem;
            const cell = document.createElement("th");
            cell.setAttribute("style", `width: ${width}%`);
            cell.appendChild(document.createTextNode(text))
            matchesTableHeaderRow.appendChild(cell);
          });
          matchesTable.appendChild(matchesTableHeader);

          const matchesTableBody = document.createElement("tbody");
          allMatches.filter((match) => match.RoundNumber === number).forEach((match) => {
            const row = matchesTableBody.insertRow();
            const player1 = allPlayers.filter(
              (player) => player.Username === match.Player1Username
            )[0];
            const player1Name = (
              player1 ? player1.PlayerNameLastFirst : match.Player1Username
            );
            const player2 = allPlayers.filter(
              (player) => player.Username === match.Player2Username
            )[0];
            const player2Name = (
              player2 ? player2.PlayerNameLastFirst : match.Player2Username
            );
            const result = match.HasResults
              ? `${match.Player1GameAndByeWins} - ${match.Player2GameAndByeWins}`
              : "Not reported";
            for (text of [
              player1Name ? player1Name : "N/A (bye)",
              result,
              player2Name ? player2Name : "N/A (bye)",
            ]) {
              row.insertCell().appendChild(document.createTextNode(text));
            }
          });
          matchesTable.appendChild(matchesTableBody);

          roundPane.appendChild(matchesTable);
          matchesPanes.appendChild(roundPane);
        });

        if (completedRoundNumbers.length === 0) {
          const standingsText = document.createElement("p");
          standingsText.appendChild(document.createTextNode("No standings"));
          standingsPanes.replaceChildren(standingsText);

          submitButton.blur();
          return;
        }

        let nextRoundPane = null;

        if (roundNumbers.length === completedRoundNumbers.length) {
          const roundTab = document.createElement("button");
          roundTab.setAttribute("type", "button");
          roundTab.setAttribute("class", "nav-link my-3");
          roundTab.setAttribute("data-bs-toggle", "pill");
          roundTab.setAttribute("data-bs-target", "#matches-next-round-pane");
          roundTab.appendChild(document.createTextNode("Next round"));
          matchesTabs.appendChild(roundTab);

          nextRoundPane = document.createElement("div");
          nextRoundPane.setAttribute("class", "tab-pane");
          nextRoundPane.setAttribute("id", "matches-next-round-pane");
          matchesPanes.appendChild(nextRoundPane);
        }

        if (allPlayers.length === 0) {
          const standingsText = document.createElement("p");
          standingsText.appendChild(
            document.createTextNode("No standings (missing player data)")
          );
          standingsPanes.replaceChildren(standingsText);

          if (nextRoundPane) {
            const pairingsHeader = document.createElement("h4");
            pairingsHeader.setAttribute("class", "my-2");
            pairingsHeader.appendChild(document.createTextNode("Pairings"));

            const pairingsText = document.createElement("p");
            pairingsText.appendChild(
              document.createTextNode("No pairings (missing player data)")
            );

            nextRoundPane.replaceChildren(pairingsHeader, pairingsText);
          }

          submitButton.blur();
          return;
        }

        const sum = (a, b) => { return a + b; };

        const computeMatches = (matches, username) => {
          return matches.filter(
            (match) => [match.Player1Username, match.Player2Username].includes(username)
          )
        };

        const computePoints = (matches, username) => {
          return computeMatches(matches, username)
            .map((match) =>
              match.GameDraws === 3
                ? 0
                : username === match.Player1Username
                  ? match.Player1GameAndByeWins === 2 ? 3 : match.Player1GameAndByeWins
                  : match.Player2GameAndByeWins === 2 ? 3 : match.Player2GameAndByeWins
            )
            .reduce(sum, 0);
        };

        const computeGamesWon = (matches, username) => {
          return computeMatches(matches, username)
            .map((match) =>
              username === match.Player1Username
                ? match.Player1GameAndByeWins : match.Player2GameAndByeWins
            )
            .reduce(sum, 0);
        };

        const computeOpponents = (matches, username) => {
          return computeMatches(matches, username)
            .map((match) =>
              username === match.Player1Username
                ? match.Player2Username : match.Player1Username
            )
            .filter((opponent) => opponent);
        };

        const computeStrengthOfSchedule = (matches, username) => {
          const opponents = computeOpponents(matches, username);
          if (opponents.length === 0) {
            return 0.0;
          }
          return (
            opponents
              .map(
                (opponent) => Math.max(
                  1 / 3,
                  computePoints(matches, opponent)
                    / (3 * computeMatches(matches, opponent).length),
                )
              )
              .reduce(sum, 0)
            / opponents.length
          );
        };

        const computeLastWins = (matches, username) => {
          return computeMatches(matches, username)
            .map((match) =>
              match.GameDraws === 3
                ? [0, 0]
                : username === match.Player1Username
                  ? match.Player1GameAndByeWins === (
                      match.Player1GameAndByeWins + match.Player2GameAndByeWins
                    ) ? [1, 1] : [0, match.Player1GameAndByeWins]
                  : match.Player2GameAndByeWins === (
                      match.Player1GameAndByeWins + match.Player2GameAndByeWins
                    ) ? [1, 1] : [0, match.Player2GameAndByeWins]
            )
            .reduce((a, b) => [a[0] + b[0], a[1] + b[1]], [0, 0])
        };

        const computeRecord = (matches, username) => {
          return computeMatches(matches, username)
            .map((match) =>
              match.GameDraws === 3
                ? [0, 1, 0]
                : username === match.Player1Username
                  ? match.Player1GameAndByeWins === 2
                    ? [1, 0, 0]
                    : match.Player1GameAndByeWins === 1 ? [0, 0, 1] : [0, 1, 0]
                  : match.Player2GameAndByeWins === 2
                    ? [1, 0, 0]
                    : match.Player2GameAndByeWins === 1 ? [0, 0, 1] : [0, 1, 0]
            )
            .reduce((a, b) => [a[0] + b[0], a[1] + b[1], a[2] + b[2]], [0, 0, 0]);
        };

        completedRoundNumbers.forEach((number) => {
          const matches = allMatches.filter((match) => match.RoundNumber <= number);
          let playerUsernames = new Set();
          matches.forEach((match) => {
            if (match.Player1Username) {
              playerUsernames.add(match.Player1Username);
            }
            if (match.Player2Username) {
              playerUsernames.add(match.Player2Username);
            }
          });
          const standings = Array.from(playerUsernames)
            .map((username) => {
              const player = allPlayers.filter(
                (player) => player.Username === username
              )[0];
              return [
                computePoints(matches, player.Username),
                computeGamesWon(matches, player.Username),
                Math.round(10e5 * computeStrengthOfSchedule(matches, player.Username))
                  / 10e5,
                computeLastWins(matches, player.Username),
                player.TeamId,
                computeRecord(matches, player.Username),
                player.PlayerNameLastFirst,
              ]
            })
            .toSorted((lhs, rhs) => {
              if (lhs[0] > rhs[0]) { return -1; } // Points
              if (lhs[0] < rhs[0]) { return 1; }
              if (lhs[1] > rhs[1]) { return -1; } // Wins
              if (lhs[1] < rhs[1]) { return 1; }
              if (lhs[2] > rhs[2]) { return -1; } // SoS
              if (lhs[2] < rhs[2]) { return 1; }
              // LastWins
              if ((lhs[3][0] + lhs[3][1]) / 2  > (rhs[3][0] + rhs[3][1]) / 2) {
                return -1;
              }
              if ((lhs[3][0] + lhs[3][1]) / 2  < (rhs[3][0] + rhs[3][1]) / 2) {
                return 1;
              }
              if (lhs[4] < rhs[4]) { return -1; } // TeamId
              if (lhs[4] > rhs[4]) { return 1; }
              return 0;
            });

          const active =
            number === completedRoundNumbers[completedRoundNumbers.length - 1];

          const roundTab = document.createElement("button");
          roundTab.setAttribute("type", "button");
          roundTab.setAttribute("class", `nav-link my-3 ${active ? "active" : ""}`);
          roundTab.setAttribute("data-bs-toggle", "pill");
          roundTab.setAttribute("data-bs-target", `#standings-round-${number}-pane`);
          roundTab.appendChild(document.createTextNode(`Round ${number}`));
          standingsTabs.appendChild(roundTab);

          const roundPane = document.createElement("div");
          roundPane.setAttribute("class", `tab-pane ${active ? "active" : ""}`);
          roundPane.setAttribute("id", `standings-round-${number}-pane`);

          const standingsTable = document.createElement("table");
          standingsTable.setAttribute("class", "table table-striped table-hover");

          const standingsTableHeader = document.createElement("thead");
          const standingsTableHeaderRow = standingsTableHeader.insertRow();
          [
            ["Rank", 10],
            ["Player", 40],
            ["Record", 10],
            ["Points", 10],
            ["Wins", 10],
            ["SoS", 10],
            ["LastWins", 10],
          ].forEach((elem) => {
            const [text, width] = elem;
            const cell = document.createElement("th");
            cell.setAttribute("style", `width: ${width}%`);
            cell.appendChild(document.createTextNode(text))
            standingsTableHeaderRow.appendChild(cell);
          });
          standingsTable.appendChild(standingsTableHeader);

          const standingsTableBody = document.createElement("tbody");
          standings.forEach((standing, index) => {
            const rank = index + 1;
            const [points, wins, sos, lastWins, _teamId, record, name] = standing;
            const row = standingsTableBody.insertRow();
            for (text of [
              rank,
              name,
              `${record[0]}-${record[1]}-${record[2]}`,
              points,
              wins,
              `${(100 * sos).toFixed(5)}%`,
              lastWins[0] === lastWins[1] ? lastWins[0] : `[${lastWins[0]}:${lastWins[1]}]`,
            ]) {
              row.insertCell().appendChild(document.createTextNode(text));
            }
          });
          standingsTable.appendChild(standingsTableBody);

          roundPane.appendChild(standingsTable);
          standingsPanes.appendChild(roundPane);
        });

        if (nextRoundPane) {
          const unpairedPlayers = allPlayers
            .filter((player) => [1, 2].includes(player.Status))
            .map((player) =>
              [Math.random(), computePoints(allMatches, player.Username), player]
            )
            .sort((lhs, rhs) => lhs[0] - rhs[0])
            .sort((lhs, rhs) => rhs[1] - lhs[1])
            .map((t) => t[2]);
          let pairings = [];
          let table = 1;
          while (unpairedPlayers.length > 1) {
            const player1 = unpairedPlayers.shift();
            const player2 = unpairedPlayers.splice(
              unpairedPlayers.findIndex(
                (player) => !computeOpponents(
                  allMatches, player1.Username
                ).includes(player.Username)
              ),
              1,
            )[0];
            pairings.push([table, player1, player2]);
            table += 1;
          }
          if (unpairedPlayers.length === 1) {
            pairings.unshift([null, unpairedPlayers[0], null]);
          }

          const pairingsHeader = document.createElement("h4");
          pairingsHeader.setAttribute("class", "my-2");
          pairingsHeader.appendChild(document.createTextNode("Pairings"));
          nextRoundPane.appendChild(pairingsHeader);

          const pairingsTable = document.createElement("table");
          pairingsTable.setAttribute("class", "table table-striped table-hover");

          const pairingsTableHeader = document.createElement("thead");
          const pairingsTableHeaderRow = pairingsTableHeader.insertRow();
          [["Table", 20], ["Player 1", 40], ["Player 2", 40]].forEach((elem) => {
            const [text, width] = elem;
            const cell = document.createElement("th");
            cell.setAttribute("style", `width: ${width}%`);
            cell.appendChild(document.createTextNode(text))
            pairingsTableHeaderRow.appendChild(cell);
          });
          pairingsTable.appendChild(pairingsTableHeader);

          const pairingsTableBody = document.createElement("tbody");
          pairings.forEach((pairing, index) => {
            const [table, player1, player2] = pairing;
            const row = pairingsTableBody.insertRow();
            for (text of [
              table ? `${table}` : "-",
              player1.PlayerNameLastFirst,
              player2 ? player2.PlayerNameLastFirst : "N/A (bye)",
            ]) {
              row.insertCell().appendChild(document.createTextNode(text));
            }
          });
          pairingsTable.appendChild(pairingsTableBody);

          nextRoundPane.appendChild(pairingsTable);

          const pairingsScriptHeader = document.createElement("h4");
          pairingsScriptHeader.setAttribute("class", "my-2");
          pairingsScriptHeader.appendChild(document.createTextNode("Pairings script"));
          nextRoundPane.appendChild(pairingsScriptHeader);

          const newPairings = pairings
            .map((pairing) =>
              JSON.stringify({
                TableNumber: pairing[0],
                Team1Id: pairing[1].TeamId,
                Team1Name: "",
                Team2Id: pairing[2] ? pairing[2].TeamId : null,
                Team2Name: pairing[2] ? "" : "Bye",
              })
            )
            .join(", ");
          const pairingsScript = document.createElement("pre");
          pairingsScript.setAttribute("style", "white-space: pre-wrap");
          pairingsScript.setAttribute("class", "bg-body-secondary p-3");
          pairingsScript.appendChild(document.createTextNode(
            "(function(){$.post(\"/Tournament/UpdatePairings\", {id:"
            + " $(\"#pairings-round-selector-container > .round-selector.active\")"
            + `.data("id"), newPairings: [${newPairings}], deletedPairings: []},`
            + " (response) => { Flattsware.notify.handleResponse(response, (response) =>"
            + " { updateTournamentMetrics(true), Flattsware.showSnackbarAlert("
            + "response.Message) }) }).fail(Flattsware.showFail) })()"
          ));
          nextRoundPane.appendChild(pairingsScript);
        }

        submitButton.blur();
      };
    </script>
  </body>
</html>
